<extend name="./Public/tmpl/index_base.html" />
<block name="title">资金记录</block>
<block name="custom_top_css" >
  <link href="/Public/static/style/ylb-ucenter.css" rel="stylesheet"/>
  <link href="/Public/static/lib/bootstrap/css/datepicker3.css" rel="stylesheet"/>
</block>
<block name="custom_content" >
    <!--start: breadcrumb -->
    <div class="container">
            <ol class="breadcrumb">
                <li><a href="/">首页</a></li>
                <li><a href="/User">个人中心</a></li>
                <li class="active"><a href="">资金记录</a></li>
            </ol>
    </div>
    <!--end: breadcrumb -->
    <div class="container">
        <div class="ucenter clearfix">
            <aside class="col-xs-2 col-md-2 aside">
                <div class="aside-body">
                    <dl class="box-shadow" sup="Account">
                        <include file="./Public/tmpl/User/aside-menu.html" keywords="side-menu-money" />
                    </dl>
                </div>
            </aside>
            <article class="col-xs-10 col-md-10 article">
                <div class="article-body box-shadow">
                    <div class="padding-lg">
                        <h2>资金记录</h2>
                        <hr />
                        <div id="head-form">
                        <form class="form-horizontal" role="form">
                            <div class="form-group">
                                <label class="col-sm-2 control-label fontsize-md">查询日期：</label>
                                <div class="col-md-6 controls">
                                    <div class="input-daterange input-group">
                                        <input type="text" class="form-control" id="start" name="start" value="{$last30day}" />
                                        <span class="input-group-addon">~</span>
                                        <input type="text" class="form-control" id="end" name="end" value="{$today}" />
                                    </div>
                                </div>
                            </div>

                            <div class="padding-sm highlight" id="cat-filter">
                                <input type="checkbox" name="check-all" id="check-all" value="0" checked> <label for="check-all">全部</label>
                                <input type="checkbox" name="check-btype-1" id="check-btype-1" value="1" checked> <label for="check-btype-1">充值</label>
                                <input type="checkbox" name="check-btype-6" id="check-btype-6" value="6,5" checked> <label for="check-btype-6">提现</label>
                                <input type="checkbox" name="check-btype-4" id="check-btype-4" value="4" checked> <label for="check-btype-4">奖励</label>
                                <input type="checkbox" name="check-btype-7" id="check-btype-7" value="7" checked> <label for="check-btype-7">消费</label>
                                <input type="checkbox" name="check-btype-3" id="check-btype-3" value="3" checked> <label for="check-btype-3">还本</label>
                                <input type="checkbox" name="check-btype-2" id="check-btype-2" value="2" checked> <label for="check-btype-2">派息</label>
                                <input type="checkbox" name="check-btype-8" id="check-btype-8" value="8" checked> <label for="check-btype-8">投资</label>
                            </div>
                            <div class="">
                                <script type="text/html" id="money-total">
                                <h3>总计: {{total}}元</h3>
                                </script>
                            </div>
                        </form>
                        </div>
                        <table class="table table-hover border-solid" id="log-list">
                          <thead>
                            <tr>
                              <th style="width:20px"></th>
                              <th style="width:120px">金额(元)</th>
                              <th style="width:120px">时间</th>
                              <th style="width:180px">类型</th>
                            </tr>
                          </thead>
                            <tbody>
                              <tr class="pre-load">
                                <td colspan=4 class="text-center">
                                  加载中....
                                </td>
                              </tr>
                              <script type="text/html" id="money-list">
                                {{if null == data || false == data || "undfined" === typeof data}}>
                                  <tr>
                                    <td colspan="4" class="text-center">
                                      当前条件下无数据...
                                    </td>
                                  </tr>
                                {{else}}
                                  {{each data as i}}
                                    <tr>
                                      <td></td>
                                      <td
                                        {{if i.io == -1}}
                                          style="color:#EB4646"
                                        {{else}}
                                          style="color:#35B659"
                                        {{/if}}
                                      >
                                        {{if i.io == -1}}-{{else}}+{{/if}}{{i.change_money | abs | number_format:2}}
                                      </td>
                                      <td title="{{i.detail_time}}">{{i.time}}</td>
                                      <td>{{i.b_type | transaction_type:''}}， {{i.s_type | transaction_type:''}}
                                    </tr>
                                  {{/each}}
                                  {{if data.length >= 30}}
                                    <tr class="load-more">
                                      <td colspan="4">
                                        <a href="javascript:void(0);" class="btn btn-primary btn-normal btn-block" id="load-more">加载更多</a>
                                      </td>
                                    </tr>
                                  {{/if}}
                                {{/if}}
                              </script>
                            </tbody>
                        </table>
                    </div>
                </div>
            </article>
        </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="relogin-tip" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <a href="/User/Login" class="close" data-dismiss="model" aria-hidden="true">&times;</a>
            <h4 class="modal-title" id="myModalLabel">提醒</h4>
          </div>
          <div class="modal-body">
            您的登录已经过期...请重新登录
          </div>
          <div class="modal-footer">
            <a href="/User/Login" class="btn btn-primary">去登录</a>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
</block>

<block name="custom_bottom_js" >
<script src="/Public/static/lib/bootstrap/bootstrap-datepicker.js"></script>
<script src="/Public/static/lib/artTemplate/template.js"></script>
<script type="text/javascript">
  (function($){
    window.transaction_i80n = {$i80n};
    template.helper('transaction_type', function(code, non_use){
      return window.transaction_i80n[code];
    });
    template.helper('abs', function(number){
      if(number < 0){
        number = 0 - number;
      }
      return number;
    });
    template.helper('number_format', function(number, decimals, dec_point, thousands_sep){
      number = number.toString().replace(/[^0-9+\-Ee.]/g, '');
      var n = !isFinite(+number) ? 0 : +number,
      prec = !isFinite(+decimals) ? 0 : Math.abs(decimals),
      sep = (typeof thousands_sep === 'undefined') ? ',' : thousands_sep,
      dec = (typeof dec_point === 'undefined') ? '.' : dec_point,
      s = '',
      toFixedFix = function(n, prec) {
        var k = Math.pow(10, prec);
        return '' + (Math.round(n * k) / k)
        .toFixed(prec);
      };
      s = (prec ? toFixedFix(n, prec) : '' + Math.round(n))
      .split('.');
      if (s[0].length > 3) {
        s[0] = s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g, sep);
      }
      if ((s[1] || '')
          .length < prec) {
            s[1] = s[1] || '';
            s[1] += new Array(prec - s[1].length + 1)
            .join('0');
          }
          return s.join(dec);
    });
    window.listpage = parseInt('{$_GET['p']}');
    window.token = $('input[name="__ylb_"]').val();
    window.type = '1,2,3,4,5,6,7,8';
    window.start = '{$last30day}';
    window.end = '{$today}';
    window.moneyListTpl = template.compile($('#money-list').html());
    window.moneyTotalTpl = template.compile($('#money-total').html());
    window.bindLoadMore = function(){
      $('a#load-more').on('click',function(){
        return window.ajaxMoreMoney();
      });
    };
    window.ajaxListMoney = function(){
      $.getJSON( 'moneyJson?xx={$Think.get.xx}&type=' + window.type + '&start=' + window.start + '&end=' + window.end + '&page=' + window.listpage, function(json){
          if(json.code==401){
            $('#relogin-tip').modal({show:true});
            return false;
          }else if(json.code==200){
            $('#log-list tbody').html( window.moneyListTpl( json ) )
            window.bindLoadMore();
          }
        });
    };
    window.ajaxMoreMoney = function(){
        window.listpage ++;
        $.getJSON( 'moneyJson?type=' + window.type + '&start=' + window.start + '&end=' + window.end + '&page=' + window.listpage, function(json){
          $('tr.load-more').hide();
          $('#log-list tbody').append( window.moneyListTpl( json ) )
          window.bindLoadMore();
        });
    };
    if(!window.listpage > 0)window.listpage = 1;
    $("#CaptchaImage").click(function() {
      //console.log('y');
      $("#CaptchaImage").attr("src", "/User/auth/verify/" + 1);
    });

    // Datapicker start..
    $('.input-daterange').datepicker({
      format:'yyyy-mm-dd'
    });
    $('#start').on('changeDate',function(){
      $('.input-daterange').datepicker({
        format:'yyyy-mm-dd'
      });
      window.start = $('#start').val();
      window.end = $('#end').val();
      window.listpage = 1;
      window.ajaxListMoney();
    });
    $('#end').on('changeDate',function(){
      $('.input-daterange').datepicker({
        format:'yyyy-mm-dd'
      });
      window.start = $('#start').val();
      window.end = $('#end').val();
      window.listpage = 1;
      window.ajaxListMoney();
    });
    $('#cat-filter input[type="checkbox"][id^="check-btype-"]').on('change',function(){
      var checked = $('#cat-filter input[type="checkbox"]:checked');
      type_string = '';
      for(i = 0; i < checked.length; i++){
        if(checked[i].value == "0")continue;
        type_string += checked[i].value;
        if(i != checked.length - 1) type_string += ',';
      }
      if( $(this) != $('#check-all') ){
        op = $(this);
        setTimeout(function(){
          if(!op.attr('checked'))
            $('#check-all').attr('checked',false);
          else if($('input[id^="check-btype-"]').not(':checked').length==0)
            $('#check-all').attr('checked','checked');
        },100);
      }
      window.listpage = 1;
      window.type = type_string;
      window.ajaxListMoney();
    });
    //check all
    $('#check-all').on('change', function(){
      setTimeout( function(){
        if($('#check-all').attr('checked'))
          $('input[id^="check-btype-"]').attr('checked','checked');
        else
          $('input[id^="check-btype-"]').attr('checked',false);
        $('#check-btype-1').trigger('change');
      }, 100)
    });
    window.ajaxListMoney();
  })(window.jQuery);
</script>
</block>
